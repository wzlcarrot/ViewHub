import{f as O,r as F,al as V,c as y,o as m,a as s,P as R,a6 as X,H as Z,I as p,M as z,O as x,Q as i,a4 as oe,u as A,S as Y,J as E,K as L,R as W,C as le,D as ae,n as D,i as se,h as ie,V as ne,z as re}from"./@vue-_Q8M3GyZ.js";import{_ as K,f as ee,m as T,u as ue,b as de}from"./index-V73uJnXy.js";import{u as G,a as j}from"./vue-router-ffDWPyKt.js";import{s as pe}from"./vue-draggable-plus-Cyz2QREE.js";import"./pinia-CtRA5Bu2.js";import"./element-plus-Bescc1QT.js";import"./lodash-es-S0Y0Up6J.js";import"./@vueuse-DfuMZOfy.js";import"./@element-plus-B8yk6LGT.js";import"./@popperjs-D_chPuIy.js";import"./@ctrl-r5W6hzzQ.js";import"./dayjs-BdefatKI.js";import"./artplayer-BnYtXt6g.js";import"./async-validator-9PlIezaS.js";import"./memoize-one-BdPwpGay.js";import"./normalize-wheel-es-BQoi3Ox2.js";import"./@floating-ui-85_40PfK.js";import"./axios-NIGUFBhG.js";import"./vue-cookies-B4eaU0RH.js";import"./@fingerprintjs-BciRmnos.js";import"./tslib-BLN2B0TR.js";import"./vue-cropper-BrUi_TYK.js";import"./mitt-DJ65BbbF.js";import"./moment-C5S46NFB.js";const ce={class:"tag-input-panel"},ve={class:"tag-list"},fe={class:"tag-input"},me={class:"info"},_e={__name:"TagInput",props:{modelValue:{type:Array,default:[]}},setup(M){const{proxy:$}=O();G(),j();const g=M,v=e=>{g.modelValue.splice(g.modelValue.indexOf(e),1)},r=F(),h=()=>{if(r.value){if(g.modelValue.length>=10){$.Message.warning("最多只能输入10个标签"),r.value="";return}g.modelValue.push(r.value),r.value=""}};return(e,u)=>{const k=V("el-tag"),d=V("el-input");return m(),y("div",ce,[s("div",ve,[(m(!0),y(R,null,X(M.modelValue,S=>(m(),Z(k,{class:"tag-item",key:S,closable:"","disable-transitions":!1,onClose:U=>v(S)},{default:p(()=>[z(x(S),1)]),_:2},1032,["onClose"]))),128))]),s("div",fe,[i(d,{placeholder:"按回车键Enter创建标签",modelValue:r.value,"onUpdate:modelValue":u[0]||(u[0]=S=>r.value=S),maxlength:15,resize:"none","show-word-limit":"",onKeyup:oe(h,["enter"])},null,8,["modelValue"])]),s("div",me,"最多还可以输入"+x(10-M.modelValue.length)+"个标签",1)])}}},ge=K(_e,[["__scopeId","data-v-14c308e7"]]),ye={class:"uploader-start-panel"},Ve={class:"upload-explain"},Ie={__name:"VideoUploadStart",emits:["addFile"],setup(M,{emit:$}){const g=ee(),{proxy:v}=O();G(),j();const r=$,h=k=>{r("addFile",k)};let e=0;const u=k=>{e==0&&T.emit("startUpload",v.Utils.getFileName(k.name)),e++};return(k,d)=>{const S=V("el-upload"),U=V("el-popover");return m(),y(R,null,[s("div",ye,[i(S,{class:"uploader-start",drag:"","show-file-list":!1,"http-request":h,"before-upload":u,accept:A(v).videoAccept},{default:p(()=>d[0]||(d[0]=[s("div",{class:"upload-handler"},[s("div",{class:"iconfont icon-upload"}),s("div",{class:"info"},"拖拽到此处也可上传"),s("div",{class:"upload-btn"},"上传视频")],-1)])),_:1,__:[0]},8,["accept"])]),s("div",Ve,[i(U,{placement:"top-end",width:400,trigger:"hover"},{reference:p(()=>d[1]||(d[1]=[s("div",{class:"item"},"视频大小",-1)])),default:p(()=>[s("div",null,[s("p",null,"网页端上传的文件大小上限为"+x(A(g).sysSetting.videoSize)+"MB",1),d[2]||(d[2]=s("p",null,"视频内容时长最大3小时",-1)),d[3]||(d[3]=s("p",null,"过长或过大视频建议拆分后使用分p或合集功能进行投稿～",-1))])]),_:1}),i(U,{placement:"top-end",width:420,trigger:"hover"},{reference:p(()=>d[4]||(d[4]=[s("div",{class:"item"},"视频格式",-1)])),default:p(()=>[d[5]||(d[5]=s("div",null,[s("p",null,"推荐上传的格式为：mp4"),s("p",null,"（推荐上传的格式在转码过程更有优势，审核过程更快哦！）"),s("p",null,"其他允许上传的格式：mp4,avi,rmvb,mkv,mov")],-1))]),_:1,__:[5]}),i(U,{placement:"top-end",width:350,trigger:"hover"},{reference:p(()=>d[6]||(d[6]=[s("div",{class:"item"},"视频码率",-1)])),default:p(()=>[d[7]||(d[7]=s("div",null,[s("p",null,"分辨率最大支持 8192*4320"),s("p",null,"推荐视频分辨率：1920*1080 或者 3840*2160")],-1))]),_:1,__:[7]})])],64)}}},he=K(Ie,[["__scopeId","data-v-4ea9e852"]]),we={class:"uploader-start-panel"},ke={key:0},Se={class:"file-list"},Ue={class:"video-p"},Ce={class:"video-p-info"},be={class:"video-info"},Fe={class:"video-title"},xe={class:"upload-info"},Ae={class:"title"},Ne=["onClick"],ze={class:"upload-status"},$e={key:0},Pe={class:"op"},Le={key:0,class:"item percent"},Me=["onClick"],qe=["onClick"],Re=["onClick"],Te={key:0,class:"video-progress"},Be={key:0,class:"add-video-btn"},Ee={__name:"VideoUploader",props:{videoList:{type:Array,default:[]}},setup(M,{expose:$}){const g=ee(),{proxy:v}=O();j();const r={emptyfile:{value:"emptyfile",desc:"文件为空",color:"#F75000",icon:"error"},largefile:{value:"largefile",desc:"文件超过大小"+g.sysSetting.videoSize+"MB",color:"#F75000",icon:"error"},wating:{value:"wating",desc:"等待上传",color:"#e6a23c",icon:"wating"},uploading:{value:"uploading",desc:"上传中",color:"#409eff",icon:"upload"},fail:{value:"fail",desc:"上传失败",color:"#F75000",icon:"error"},success:{value:"success",desc:"上传完成",color:"#67c23a",icon:"success"}},h=v.chunkSize,e=v.maxUploading,u=F([]),k=n=>u.value.find(t=>t.uid==n),d=F(!1);T.on("startUpload",()=>{u.value=[],d.value=!0});const S=n=>{if(n=n.file,u.value.length>=g.sysSetting.videoPCount){v.Message.warning("最多可以添加"+g.sysSetting.videoPCount+"个视频");return}let o=n.name;const t=o.lastIndexOf(".");o=t==-1?o:o.substring(0,t);const f={file:n,uid:n.uid,fileName:o,status:r.wating.value,uploadSize:0,totalSize:n.size,uploadPercent:0,pause:!1,chunkIndex:0,errorMsg:null};if(u.value.push(f),f.totalSize==0){f.status=r.emptyfile.value;return}if(f.totalSize>g.sysSetting.videoSize*1024*1024){f.status=r.largefile.value;return}u.value.filter(b=>b.status==r.uploading.value).length>=e||U(f.uid)},U=async(n,o)=>{const t=k(n);t.status=r.uploading.value,o=o||0;const f=t.file,I=t.totalSize,b=Math.ceil(I/h);if(!t.uploadId){let a=await v.Request({url:v.Api.preUploadVideo,params:{fileName:t.fileName,chunks:b},errorCallback:c=>{t.status=r.fail.value,t.errorMsg=c}});if(!a)return;t.uploadId=a.data}for(let a=o;a<b&&!(t.pause||t.del);a++){let c=a*h,N=c+h>=I?I:c+h,te=f.slice(c,N);if(await v.Request({url:v.Api.uploadVideo,dataType:"file",params:{chunkFile:te,chunkIndex:a,uploadId:t.uploadId},showError:!1,errorCallback:q=>{t.status=r.fail.value,t.errorMsg=q},uploadProgressCallback:q=>{let J=q.loaded;J>I&&(J=I),t.uploadSize=a*h+J,t.uploadPercent=Math.floor(t.uploadSize/I*100)}})==null)break;if(t.chunkIndex=a,a<b-1)continue;t.status=r.success.value,t.uploadProgress=100;const Q=u.value.find(q=>q.status==r.wating.value);Q&&U(Q.uid)}},H=n=>{const o=k(n);o.pause=!0},B=n=>{const o=k(n);o.pause=!1,U(n,o.chunkIndex)},w=async n=>{const o=u.value[n];o.del=!0,u.value.splice(n,1),!o.fileId&&await v.Request({url:v.Api.delUploadVideo,dataType:"file",params:{uploadId:o.uploadId},showError:!1})},l=n=>{const o=u.value[n];o.edit=!0,D(()=>{const t=document.querySelector("#file-input"+o.uid);setTimeout(()=>{t.focus()},100)})},_=n=>{const o=u.value[n];o.edit=!1};return $({getUploadFileList:()=>{let n=0,o=0;for(let f=0,I;I=u.value[f],f<u.value.length;f++){if(I.status===r.fail.value||I.status==r.emptyfile.value){n++;continue}if(I.status===r.uploading.value||I.status===r.wating.value){o++;continue}}return n>0?(v.Message.warning("请删除上传失败的文件"),null):o>0?(v.Message.warning("文件还未上传完成无法提交"),null):u.value.map(f=>({uploadId:f.uploadId,fileId:f.fileId,fileName:f.fileName}))},initUploader:(n,o)=>{d.value=n,u.value.splice(0,u.value.length),o.forEach(t=>{t.transferResult==1?t.status=r.success.value:t.status=r.fail.value,t.uid=t.fileId,t.uploadPercent=100,u.value.push(t)})}}),Y(()=>{T.off("startUpload")}),(n,o)=>{const t=V("el-input"),f=V("el-progress"),I=V("el-button"),b=V("el-upload");return m(),y(R,null,[E(s("div",we,[i(he,{onAddFile:S})],512),[[W,!d.value]]),d.value?(m(),y("div",ke,[E((m(),y("div",Se,[(m(!0),y(R,null,X(u.value,(a,c)=>(m(),y("div",{class:"file-item",key:c},[s("div",Ue,[o[0]||(o[0]=s("div",{class:"iconfont icon-video"},null,-1)),s("div",Ce,"P"+x(c+1),1)]),s("div",be,[s("div",Fe,[s("div",xe,[s("div",Ae,[E(i(t,{id:"file-input"+a.uid,modelValue:a.fileName,"onUpdate:modelValue":N=>a.fileName=N,size:"small",onBlur:N=>_(c)},null,8,["id","modelValue","onUpdate:modelValue","onBlur"]),[[W,a.edit]]),E(s("div",{class:"title-show",onClick:N=>l(c)},x(a.fileName),9,Ne),[[W,!a.edit]])]),s("div",ze,[a.status=="uploading"?(m(),y("span",$e," 已经上传："+x(A(v).Utils.size2Str(a.uploadSize))+"/"+x(A(v).Utils.size2Str(a.totalSize)),1)):(m(),y("span",{key:1,class:ae(["iconfont","icon-"+r[a.status].icon]),style:le({color:r[a.status].color})},x(r[a.status].desc),7))])]),s("div",Pe,[a.status=="uploading"?(m(),y("div",Le,x(a.uploadPercent)+"% ",1)):L("",!0),a.status=="uploading"?(m(),y(R,{key:1},[a.pause?(m(),y("div",{key:0,class:"item iconfont icon-play3",onClick:N=>B(a.uid)},null,8,Me)):(m(),y("div",{key:1,class:"item iconfont icon-pause",onClick:N=>H(a.uid)},null,8,qe))],64)):L("",!0),s("div",{class:"item iconfont icon-del",onClick:N=>w(c)},null,8,Re)])]),a.status=="uploading"||a.status=="success"?(m(),y("div",Te,[i(f,{percentage:a.uploadPercent,"show-text":!1,"stroke-width":3,status:a.status=="uploading"?"":"success"},null,8,["percentage","status"])])):L("",!0)])]))),128))])),[[A(pe),[u.value,{animation:150,handle:".video-p"}]]]),u.value.length<A(g).sysSetting.videoPCount?(m(),y("div",Be,[i(b,{multiple:"","show-file-list":!1,"http-request":S,accept:A(v).videoAccept},{default:p(()=>[i(I,{type:"primary"},{default:p(()=>o[1]||(o[1]=[z("添加分P",-1)])),_:1,__:[1]})]),_:1},8,["accept"])])):L("",!0)])):L("",!0)],64)}}},De=K(Ee,[["__scopeId","data-v-28796983"]]),Oe={class:"upload-video-panel"},Ke={key:0,class:"video-form"},je={__name:"Post",setup(M){const $=ue(),{proxy:g}=O(),v=G(),r=j(),h=F(!1);T.on("startUpload",w=>{h.value=!0,D(()=>{u.value.resetFields(),e.value={},e.value.tags=[],e.value.videoName=w})});const e=F({tags:[]}),u=F(),k={videoCover:[{required:!0,message:"封面不能为空"}],videoName:[{required:!0,message:"标题不能为空"}],postType:[{required:!0,message:"类型不能为空"}],originInfo:[{required:!0,message:"转载说明不能为空"}],categoryArray:[{required:!0,message:"分区不能为空"}],tags:[{required:!0,message:"标签不能为空"}]};re("cutImageCallback",({coverImage:w})=>{e.value.videoCover=w});const d=F();F([]);const S=()=>{const w=d.value.getUploadFileList();w&&u.value.validate(async l=>{if(!l)return;let _={uploadFileList:JSON.stringify(w)};if(Object.assign(_,e.value),_.pCategoryId=_.categoryArray[0],_.categoryArray.length>1&&(_.categoryId=_.categoryArray[1]),delete _.categoryArray,_.interactionArray&&(_.interaction=_.interactionArray.join(","),delete _.interactionArray),_.videoCover instanceof File){const P=await de(_.videoCover);if(!P)return;_.videoCover=P}await g.Request({url:g.Api.postVideo,showLoading:!0,params:_})&&(g.Message.success("发布成功"),r.push("/ucenter/video"))})},U=F(),H=async()=>{if(D(()=>{d.value.initUploader(h.value,[])}),U.value){let w=await g.Request({url:g.Api.getVideoByVideoId,params:{videoId:U.value}});if(!w)return;e.value=w.data.videoInfo,e.value.tags=e.value.tags.split(","),e.value.categoryArray=[],e.value.pCategoryId&&e.value.categoryArray.push(e.value.pCategoryId),e.value.categoryId&&e.value.categoryArray.push(e.value.categoryId),e.value.interactionArray=e.value.interaction?e.value.interaction.split(","):[],D(()=>{d.value.initUploader(h.value,w.data.videoInfoFileList)})}};se(()=>v.query.videoId,(w,l)=>{w?h.value=!0:h.value=!1,U.value=w,H()},{immediate:!0,deep:!0});const B=()=>{};return ie(()=>{window.addEventListener("beforeunload",B)}),Y(()=>{T.off("startUpload"),window.removeEventListener("beforeunload",B)}),(w,l)=>{const _=V("ImageCoverSelect"),C=V("el-form-item"),P=V("el-input"),n=V("el-radio"),o=V("el-radio-group"),t=V("el-cascader"),f=V("el-checkbox"),I=V("el-checkbox-group"),b=V("el-button"),a=V("el-form");return m(),y("div",Oe,[i(De,{ref_key:"videoUploaderRef",ref:d},null,512),h.value?(m(),y("div",Ke,[i(a,{model:e.value,rules:k,ref_key:"formDataRef",ref:u,"label-width":"70px",onSubmit:l[8]||(l[8]=ne(()=>{},["prevent"]))},{default:p(()=>[i(C,{label:"封面",prop:"videoCover"},{default:p(()=>[i(_,{coverWidth:200,cutWidth:680,scale:.6,coverImage:e.value.videoCover},null,8,["coverImage"])]),_:1}),i(C,{label:"标题",prop:"videoName"},{default:p(()=>[i(P,{clearable:"",placeholder:"请输入标题",modelValue:e.value.videoName,"onUpdate:modelValue":l[0]||(l[0]=c=>e.value.videoName=c),maxlength:"100","show-word-limit":""},null,8,["modelValue"])]),_:1}),i(C,{label:"类型",prop:"postType"},{default:p(()=>[i(o,{modelValue:e.value.postType,"onUpdate:modelValue":l[1]||(l[1]=c=>e.value.postType=c)},{default:p(()=>[i(n,{value:0},{default:p(()=>l[9]||(l[9]=[z("自制",-1)])),_:1,__:[9]}),i(n,{value:1},{default:p(()=>l[10]||(l[10]=[z("转载",-1)])),_:1,__:[10]})]),_:1},8,["modelValue"])]),_:1}),e.value.postType==1?(m(),Z(C,{key:0,label:"",prop:"originInfo"},{default:p(()=>[i(P,{clearable:"",placeholder:"转载视频请注明来源、时间、地点(例：转自https://www.xxxx.com/yyyy)，注明来源会更快地通过审核哦",modelValue:e.value.originInfo,"onUpdate:modelValue":l[2]||(l[2]=c=>e.value.originInfo=c),maxlength:"200","show-word-limit":""},null,8,["modelValue"])]),_:1})):L("",!0),i(C,{label:"标签",prop:"tags"},{default:p(()=>[i(ge,{modelValue:e.value.tags,"onUpdate:modelValue":l[3]||(l[3]=c=>e.value.tags=c)},null,8,["modelValue"])]),_:1}),i(C,{label:"分区",prop:"categoryArray"},{default:p(()=>[i(t,{modelValue:e.value.categoryArray,"onUpdate:modelValue":l[4]||(l[4]=c=>e.value.categoryArray=c),options:A($).categoryList,props:{value:"categoryId",label:"categoryName"}},null,8,["modelValue","options"])]),_:1}),i(C,{label:"简介",prop:"introduction"},{default:p(()=>[i(P,{clearable:"",placeholder:"填写更全面的相关信息，让更多的人能找到你的视频吧(: 	",type:"textarea",rows:5,maxlength:2e3,resize:"none","show-word-limit":"",modelValue:e.value.introduction,"onUpdate:modelValue":l[5]||(l[5]=c=>e.value.introduction=c)},null,8,["modelValue"])]),_:1}),i(C,{label:"互动设置",prop:"introduction"},{default:p(()=>[i(I,{modelValue:e.value.interactionArray,"onUpdate:modelValue":l[6]||(l[6]=c=>e.value.interactionArray=c)},{default:p(()=>[i(f,{value:"0"},{default:p(()=>l[11]||(l[11]=[z("关闭弹幕",-1)])),_:1,__:[11]}),i(f,{value:"1"},{default:p(()=>l[12]||(l[12]=[z("关闭评论",-1)])),_:1,__:[12]})]),_:1},8,["modelValue"])]),_:1}),i(C,{label:""},{default:p(()=>[i(b,{type:"primary",onClick:S},{default:p(()=>l[13]||(l[13]=[z("立即投稿",-1)])),_:1,__:[13]}),i(b,{onClick:l[7]||(l[7]=c=>A(r).push("/ucenter/video"))},{default:p(()=>l[14]||(l[14]=[z("取消",-1)])),_:1,__:[14]})]),_:1})]),_:1},8,["model"])])):L("",!0)])}}},gt=K(je,[["__scopeId","data-v-10eac7ad"]]);export{gt as default};
